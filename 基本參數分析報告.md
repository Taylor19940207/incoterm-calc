# 📋 基本參數區塊 - 四個輸入欄位分析報告

## 🎯 分析對象

**分析範圍：** 基本參數區塊中的四個關鍵輸入欄位  
**分析目的：** 理解這四個欄位的邏輯、用途和影響  

---

## 🔍 四個輸入欄位詳解

### 1. 單箱模式 (perBox) - 1個欄位

#### 欄位名稱
- **`boxPrice`** - 單箱價格

#### 輸入邏輯
```typescript
// 用戶輸入：每箱多少錢
boxPrice: number;  // 例如：500 JPY/箱
```

#### 計算邏輯
```typescript
// 總貨值 = 訂購箱數 × 單箱價格
productValue = (product.orderBoxes || 0) * (product.boxPrice || 0);

// 總數量 = 訂購箱數 × 單箱數量  
productQty = (product.orderBoxes || 0) * (product.boxQuantity || 1);
```

#### 使用場景
- 批發商採購
- 標準化包裝商品
- 按箱銷售的業務模式

---

### 2. 單個模式 (perUnit) - 2個欄位

#### 欄位名稱
- **`unitPrice`** - 單個價格
- **`totalQuantity`** - 總數量

#### 輸入邏輯
```typescript
// 用戶輸入：
unitPrice: number;      // 例如：50 JPY/個
totalQuantity: number;  // 例如：100 個
```

#### 計算邏輯
```typescript
// 總貨值 = 總數量 × 單個價格
productValue = productQty * (product.unitPrice || 0);

// 體積計算 = 需要的箱數 × 單箱體積
const boxQty = Math.ceil((product.totalQuantity || 0) / (product.boxQuantity || 1));
totalVolume += boxQty * (product.volume || 0);
```

#### 使用場景
- 按件計價業務
- 定製化產品
- 小批量訂單

---

### 3. 整票總額模式 (inputMode) - 2個選項

#### 欄位名稱
- **`inputMode: "total"`** - 整票總額模式
- **`inputMode: "perUnit"`** - 每單位模式

#### 輸入邏輯
```typescript
// 用戶選擇：
inputMode: "total" | "perUnit";  // 二選一
```

#### 計算邏輯
```typescript
// 整票模式：顯示整票金額
if (inputs.inputMode === "total") {
  return String(costItem.shipmentTotal);
}

// 每單位模式：顯示每單位金額
if (perUnitFields.has(name)) {
  return String(derived.qty > 0 ? costItem.shipmentTotal / derived.qty : 0);
}
```

#### 使用場景
- **整票模式：** 固定成本高的業務
- **每單位模式：** 變動成本為主的業務

---

## 🔄 四個欄位的相互關係

### 數據流向圖
```
用戶輸入 → 基本參數區塊 → 計算引擎 → 最終報價
    ↓
┌─────────────────────────────────────┐
│ 單箱模式：boxPrice                  │
│ 單個模式：unitPrice + totalQuantity │  
│ 整票模式：inputMode 選擇            │
└─────────────────────────────────────┘
    ↓
商品基礎成本計算 → 費用分攤 → 單位成本 → 建議報價
```

### 相互影響關係
1. **單箱/單個模式** 決定商品基礎成本
2. **整票/每單位模式** 決定費用輸入方式
3. **四者結合** 影響最終的單位成本和報價

---

## 💰 對成本計算的影響

### 1. 對單位成本的影響
```typescript
// 基礎貨值計算
let baseGoods = 0;
if (product.inputMode === 'perBox') {
  baseGoods = (product.orderBoxes || 0) * (product.boxPrice || 0);
} else {
  baseGoods = (product.totalQuantity || 0) * (product.unitPrice || 0);
}

// 單位成本 = 基礎貨值 + 分攤的出口費用
const costPerUnit = (baseGoods / qty) + exportCostPerUnit;
```

### 2. 對費用分攤的影響
```typescript
// 分攤基數計算
const allocationBase = {
  quantity: productQty,           // 數量
  volume: productVolume,          // 體積  
  value: productValue,            // 貨值
  hybrid: {                       // 混合
    fixed: productValue,          // 固定費用按貨值
    logistics: productVolume      // 物流費用按體積
  }
};
```

---

## 🏢 業務邏輯分析

### 為什麼需要四種不同的輸入方式？

#### 1. 業務模式多樣性
- **批發商：** 習慣按箱採購，需要單箱模式
- **零售商：** 習慣按件採購，需要單個模式
- **大客戶：** 需要整票總額的報價方式
- **小客戶：** 需要每單位的詳細成本

#### 2. 成本結構差異
- **固定成本高：** 適合整票模式
- **變動成本高：** 適合每單位模式
- **包裝成本：** 單箱模式更準確
- **個別成本：** 單個模式更精確

#### 3. 計算精度要求
- **批量業務：** 單箱模式計算簡單
- **定製業務：** 單個模式計算精確
- **成本分析：** 整票模式便於分析
- **報價競爭：** 每單位模式便於比較

---

## 🔧 技術實現細節

### 1. 數據結構設計
```typescript
interface Product {
  inputMode: ProductInputMode;  // "perBox" | "perUnit"
  
  // 單箱模式
  boxPrice?: number;      // 單箱價格
  boxQuantity?: number;   // 單箱數量
  orderBoxes?: number;    // 訂購箱數
  
  // 單個模式  
  unitPrice?: number;     // 單個價格
  totalQuantity?: number; // 總數量
  
  // 通用屬性
  volume: number;         // 單箱體積
  weight: number;         // 單箱重量
}
```

### 2. 計算引擎設計
```typescript
export function calculateDerivedValues(products: Product[]) {
  let qty = 0;
  let sumVal = 0;
  
  products.forEach(product => {
    if (product.inputMode === 'perBox') {
      // 單箱模式計算
      productQty = (product.orderBoxes || 0) * (product.boxQuantity || 1);
      productValue = (product.orderBoxes || 0) * (product.boxPrice || 0);
    } else {
      // 單個模式計算
      productQty = product.totalQuantity || 0;
      productValue = productQty * (product.unitPrice || 0);
    }
    
    qty += productQty;
    sumVal += productValue;
  });
  
  return { qty, sumVal, totalVolume, totalWeight };
}
```

---

## 📊 實際應用案例

### 案例1：批發商採購
**輸入方式：** 單箱模式
- `boxPrice`: 500 JPY/箱
- `boxQuantity`: 10 個/箱  
- `orderBoxes`: 100 箱
- **結果：** 總貨值 = 500 × 100 = 50,000 JPY

### 案例2：零售商採購
**輸入方式：** 單個模式
- `unitPrice`: 50 JPY/個
- `totalQuantity`: 1000 個
- **結果：** 總貨值 = 50 × 1000 = 50,000 JPY

### 案例3：大客戶整票報價
**輸入方式：** 整票總額模式
- 直接輸入整批總費用
- 系統自動計算每單位成本
- **優勢：** 簡化報價流程

### 案例4：小客戶詳細報價
**輸入方式：** 每單位模式
- 詳細顯示每項費用
- 便於客戶理解成本結構
- **優勢：** 提高報價透明度

---

## ⚠️ 注意事項和限制

### 1. 輸入限制
- 單箱模式和單個模式不能同時使用
- 整票模式和每單位模式是互斥選擇
- 數量必須為正整數

### 2. 計算限制
- 體積和重量基於箱數計算
- 費用分攤需要至少一個產品
- 除零保護機制

### 3. 業務限制
- 單箱模式適合標準化產品
- 單個模式適合定製化產品
- 整票模式適合固定成本高的業務

---

## 🚀 優化建議

### 1. 用戶體驗優化
- 根據業務類型自動推薦輸入模式
- 提供輸入模式的說明和示例
- 增加輸入驗證和錯誤提示

### 2. 計算精度優化
- 支持小數點精度的數量輸入
- 增加成本分攤的權重調整
- 支持自定義分攤公式

### 3. 業務功能擴展
- 支持混合模式（部分按箱，部分按件）
- 增加批量導入功能
- 支持歷史報價的比較分析

---

## 📝 總結

這四個輸入欄位是整個 Incoterm 計算器的核心，它們：

1. **決定了商品基礎成本的計算方式**
2. **影響了費用分攤的邏輯和精度**
3. **支持了不同的業務模式和需求**
4. **提供了靈活的報價計算能力**

理解這四個欄位的邏輯和用途，有助於：
- 選擇最適合的輸入方式
- 優化成本計算的準確性
- 提高報價的競爭力
- 支持多樣化的業務需求

這是一個設計良好的系統，能夠適應不同規模和類型的國際貿易業務。

---

## 📚 相關文檔

- [系統架構說明](./系統架構.md)
- [計算邏輯詳解](./計算邏輯.md)
- [API 接口文檔](./API文檔.md)
- [用戶操作手冊](./操作手冊.md)

---

*報告生成時間：2024年12月*  
*版本：v1.0.0*
