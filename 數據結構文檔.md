# Incoterm å ±åƒ¹ç³»çµ± - æ•¸æ“šçµæ§‹æ–‡æª”

## ğŸ“‹ ç›®éŒ„
- [æ ¸å¿ƒæ•¸æ“šæ¨¡å‹](#æ ¸å¿ƒæ•¸æ“šæ¨¡å‹)
- [å­˜å„²æ¶æ§‹](#å­˜å„²æ¶æ§‹)
- [Repository æ¨¡å¼](#repository-æ¨¡å¼)
- [æ•¸æ“šæµç¨‹](#æ•¸æ“šæµç¨‹)
- [API æ¥å£è¨­è¨ˆ](#api-æ¥å£è¨­è¨ˆ)

---

## ğŸ—ï¸ æ ¸å¿ƒæ•¸æ“šæ¨¡å‹

### 1. Quote (å ±åƒ¹å–®) - ä¸»è¦å¯¦é«”

```typescript
interface Quote {
  // åŸºç¤è­˜åˆ¥
  id: string;                    // UUID v4
  code: string;                  // å ±åƒ¹å–®è™Ÿ (Q2025-0001)
  status: 'draft' | 'sent' | 'won' | 'lost' | 'void';
  
  // æ™‚é–“æˆ³
  createdAt: string;             // ISO 8601
  updatedAt: string;             // ISO 8601
  
  // æ•¸æ“šåˆ†å±¤
  meta: QuoteMeta;               // å®¢æˆ¶/å–®æ“šå…ƒæ•¸æ“š
  inputs: QuoteInputs;           // è¨ˆç®—åƒæ•¸ (å”¯ä¸€ä¾†æº)
  derived: QuoteDerived;         // è¨ˆç®—çµæœå¿«ç…§
}
```

### 2. QuoteMeta (å®¢æˆ¶/å–®æ“šå…ƒæ•¸æ“š)

```typescript
interface QuoteMeta {
  // å®¢æˆ¶ä¿¡æ¯
  customerName: string;          // å®¢æˆ¶åç¨± (å¿…å¡«)
  contactInfo?: string;          // è¯çµ¡æ–¹å¼
  customerId?: string;           // å®¢æˆ¶ID (æœªä¾†æ“´å±•)
  
  // å–®æ“šä¿¡æ¯
  paymentTerms?: string;         // ä»˜æ¬¾æ¢ä»¶
  validUntil?: string;           // æœ‰æ•ˆæœŸ (ISO 8601)
  notes?: string;                // å‚™è¨»
  
  // æ¥­å‹™ä¿¡æ¯ (ä¸åƒèˆ‡è¨ˆç®—)
  salesperson?: string;          // æ¥­å‹™å“¡
  projectName?: string;          // å°ˆæ¡ˆåç¨±
  reference?: string;            // åƒè€ƒè™Ÿ
}
```

### 3. QuoteInputs (è¨ˆç®—åƒæ•¸ - å”¯ä¸€ä¾†æº)

```typescript
interface QuoteInputs {
  // è²¿æ˜“æ¢ä»¶
  incotermFrom: 'EXW' | 'FOB' | 'CFR' | 'CIF' | 'DAP' | 'DDP';
  incotermTo: 'EXW' | 'FOB' | 'CFR' | 'CIF' | 'DAP' | 'DDP';
  
  // å®šåƒ¹è¨­å®š
  markupMode: 'markup' | 'margin';  // åŠ åƒ¹æ¨¡å¼
  markupPct: number;                 // åŠ åƒ¹ç‡ (%)
  currency: 'JPY' | 'USD' | 'TWD';  // è²¨å¹£
  
  // å•†å“åˆ—è¡¨
  products: Product[];
  
  // æˆæœ¬åƒæ•¸
  costs: CostParameters;
  
  // ç‰©æµè¨­å®š
  logistics: LogisticsConfig;
}
```

### 4. Product (å•†å“)

```typescript
interface Product {
  id: string;                    // UUID v4
  name: string;                  // å•†å“åç¨±
  description?: string;          // å•†å“æè¿°
  
  // è¦æ ¼åƒæ•¸
  length: number;                // é•·åº¦ (mm)
  width: number;                 // å¯¬åº¦ (mm)
  height: number;                // é«˜åº¦ (mm)
  weight: number;                // é‡é‡ (kg)
  
  // è¨ˆç®—æ¨¡å¼
  inputMode: 'perBox' | 'perUnit';  // å–®ç®±æ¨¡å¼ | å–®å€‹æ¨¡å¼
  
  // åƒ¹æ ¼è¨­å®š
  supplierUnitPrice: number;     // ä¾›æ‡‰å•†å–®åƒ¹
  units: number;                 // æ•¸é‡
  
  // ç‰©æµä¿‚æ•¸
  transportMode: 'volume' | 'weight' | 'custom';
  customDivisor?: number;        // è‡ªå®šç¾©é™¤æ•¸
  
  // è¨ˆç®—çµæœ (æ´¾ç”Ÿ)
  cbm?: number;                  // é«”ç© (mÂ³)
  chargeableWeight?: number;     // è¨ˆè²»é‡é‡ (kg)
  logisticsFactor?: number;      // ç‰©æµä¿‚æ•¸
}
```

### 5. CostParameters (æˆæœ¬åƒæ•¸)

```typescript
interface CostParameters {
  // æ•´ç¥¨è²»ç”¨
  totalFreight: number;          // ç¸½é‹è²»
  totalInsurance: number;        // ç¸½ä¿éšªè²»
  totalDocumentation: number;    // ç¸½æ–‡ä»¶è²»
  totalPortCharges: number;      // ç¸½æ¸¯é›œè²»
  totalOther: number;            // å…¶ä»–è²»ç”¨
  
  // å–®å€‹è²»ç”¨ (å¯é¸)
  perUnitFreight?: number;       // å–®å€‹é‹è²»
  perUnitInsurance?: number;     // å–®å€‹ä¿éšªè²»
  perUnitDocumentation?: number; // å–®å€‹æ–‡ä»¶è²»
  perUnitPortCharges?: number;   // å–®å€‹æ¸¯é›œè²»
  perUnitOther?: number;         // å–®å€‹å…¶ä»–è²»ç”¨
  
  // è¨ˆç®—æ¨¡å¼
  costMode: 'total' | 'perUnit'; // æ•´ç¥¨ç¸½é¡ | å–®å€‹æ¨¡å¼
}
```

### 6. LogisticsConfig (ç‰©æµè¨­å®š)

```typescript
interface LogisticsConfig {
  // é‹è¼¸æ–¹å¼
  transportMode: 'air' | 'sea' | 'land';
  
  // åŒ…è£è¨­å®š
  packagingType: 'standard' | 'custom';
  packagingWeight?: number;      // åŒ…è£é‡é‡ (kg)
  
  // ç‰¹æ®Šè¦æ±‚
  specialRequirements?: string;
  handlingInstructions?: string;
}
```

### 7. QuoteDerived (è¨ˆç®—çµæœå¿«ç…§)

```typescript
interface QuoteDerived {
  // å•†å“è¨ˆç®—çµæœ
  items: QuoteItem[];
  
  // ç¸½è¨ˆ
  totals: QuoteTotals;
  
  // æˆæœ¬åˆ†è§£
  costBreakdown: CostBreakdown;
  
  // åˆ©æ½¤åˆ†æ
  profitAnalysis: ProfitAnalysis;
}
```

### 8. QuoteItem (å•†å“è¨ˆç®—çµæœ)

```typescript
interface QuoteItem {
  productId: string;             // å•†å“ID
  name: string;                  // å•†å“åç¨±
  
  // åŸºç¤æ•¸æ“š
  units: number;                 // æ•¸é‡
  supplierUnitPrice: number;     // ä¾›æ‡‰å•†å–®åƒ¹
  
  // è¨ˆç®—çµæœ
  unitCost: number;              // å–®ä½æˆæœ¬
  unitQuote: number;             // å–®ä½å ±åƒ¹
  totalCost: number;             // ç¸½æˆæœ¬
  totalQuote: number;            // ç¸½å ±åƒ¹
  
  // åˆ©æ½¤
  unitProfit: number;            // å–®ä½åˆ©æ½¤
  totalProfit: number;           // ç¸½åˆ©æ½¤
  marginPct: number;             // æ¯›åˆ©ç‡ (%)
}
```

### 9. QuoteTotals (ç¸½è¨ˆ)

```typescript
interface QuoteTotals {
  // æ•¸é‡çµ±è¨ˆ
  totalUnits: number;            // ç¸½æ•¸é‡
  
  // é‡‘é¡çµ±è¨ˆ
  totalGoodsValue: number;       // å•†å“ç¸½å€¼
  totalExportCosts: number;      // å‡ºå£è²»ç”¨ç¸½è¨ˆ
  shipmentCostInclGoods: number; // å«å•†å“é‹è²»
  totalQuote: number;            // ç¸½å ±åƒ¹
  
  // åˆ©æ½¤çµ±è¨ˆ
  totalProfit: number;           // ç¸½åˆ©æ½¤
  avgMarginPct: number;          // å¹³å‡æ¯›åˆ©ç‡ (%)
}
```

### 10. CostBreakdown (æˆæœ¬åˆ†è§£)

```typescript
interface CostBreakdown {
  freight: number;               // é‹è²»
  insurance: number;             // ä¿éšªè²»
  documentation: number;         // æ–‡ä»¶è²»
  portCharges: number;           // æ¸¯é›œè²»
  other: number;                 // å…¶ä»–è²»ç”¨
  
  // å æ¯”åˆ†æ
  freightPct: number;            // é‹è²»å æ¯” (%)
  insurancePct: number;          // ä¿éšªè²»å æ¯” (%)
  documentationPct: number;      // æ–‡ä»¶è²»å æ¯” (%)
  portChargesPct: number;        // æ¸¯é›œè²»å æ¯” (%)
  otherPct: number;              // å…¶ä»–è²»ç”¨å æ¯” (%)
}
```

### 11. ProfitAnalysis (åˆ©æ½¤åˆ†æ)

```typescript
interface ProfitAnalysis {
  // åˆ©æ½¤æŒ‡æ¨™
  totalProfit: number;           // ç¸½åˆ©æ½¤
  avgMarginPct: number;          // å¹³å‡æ¯›åˆ©ç‡
  profitPerUnit: number;         // å–®ä½åˆ©æ½¤
  
  // æˆæœ¬çµæ§‹
  costRatio: number;             // æˆæœ¬æ¯”ç‡
  markupRatio: number;           // åŠ åƒ¹æ¯”ç‡
  
  // é¢¨éšªæŒ‡æ¨™
  breakEvenPoint: number;        // æç›Šå¹³è¡¡é»
  profitMargin: number;          // åˆ©æ½¤é‚Šéš›
}
```

---

## ğŸ’¾ å­˜å„²æ¶æ§‹

### 1. æœ¬åœ°å­˜å„² (localStorage)

```typescript
// å­˜å„²éµå€¼
const STORAGE_KEYS = {
  QUOTES: 'incoterm-quotes',           // å ±åƒ¹å–®åˆ—è¡¨
  SEQUENCE: 'incoterm-quote-sequence', // åºè™Ÿè¨ˆæ•¸å™¨
  PREFERENCES: 'incoterm-preferences', // ç”¨æˆ¶åå¥½
  CALCULATOR_INPUTS: 'incoterm-inputs' // è¨ˆç®—å™¨è¼¸å…¥ (è‡¨æ™‚)
};

// æ•¸æ“šçµæ§‹
interface StoredData {
  quotes: Quote[];                     // å ±åƒ¹å–®æ•¸çµ„
  sequence: number;                    // ç•¶å‰åºè™Ÿ
  preferences: UserPreferences;        // ç”¨æˆ¶åå¥½
  calculatorInputs: CalculatorInputs;  // è¨ˆç®—å™¨ç‹€æ…‹
}
```

### 2. æ•¸æ“šæŒä¹…åŒ–ç­–ç•¥

```typescript
// è‡ªå‹•ä¿å­˜è§¸ç™¼æ¢ä»¶
const AUTO_SAVE_TRIGGERS = [
  'productQuotes è®ŠåŒ–',
  'inputs è®ŠåŒ–',
  'costParameters è®ŠåŒ–',
  'logisticsConfig è®ŠåŒ–'
];

// æ•¸æ“šç‰ˆæœ¬æ§åˆ¶
interface DataVersion {
  schemaVersion: string;               // æ•¸æ“šçµæ§‹ç‰ˆæœ¬
  appVersion: string;                  // æ‡‰ç”¨ç‰ˆæœ¬
  lastUpdated: string;                 // æœ€å¾Œæ›´æ–°æ™‚é–“
}
```

---

## ğŸ”„ Repository æ¨¡å¼

### 1. QuoteRepo æ¥å£

```typescript
interface QuoteRepo {
  // åŸºç¤ CRUD
  list(): Promise<Quote[]>;
  get(id: string): Promise<Quote | undefined>;
  create(input: CreateQuoteInput): Promise<Quote>;
  update(id: string, patch: UpdateQuoteInput): Promise<Quote>;
  remove(id: string): Promise<void>;
  
  // æ¥­å‹™æ“ä½œ
  duplicate(id: string): Promise<Quote>;
  exportToJson(): Promise<string>;
  importFromJson(json: string): Promise<void>;
  
  // çµ±è¨ˆåˆ†æ
  getStats(): Promise<DashboardStats>;
  getTrendData(): Promise<TrendData[]>;
  getCostShareData(): Promise<CostShareData[]>;
  getRecentQuotes(limit?: number): Promise<Quote[]>;
  
  // å·¥å…·æ–¹æ³•
  getNextQuoteCode(): Promise<string>;
}
```

### 2. LocalQuoteRepo å¯¦ç¾

```typescript
class LocalQuoteRepo implements QuoteRepo {
  private storageKey = 'incoterm-quotes';
  private sequenceKey = 'incoterm-quote-sequence';
  
  // ä½¿ç”¨ localStorage ä½œç‚ºå­˜å„²å¾Œç«¯
  // æ”¯æŒå®Œæ•´çš„ CRUD æ“ä½œ
  // åŒ…å«æ•¸æ“šé©—è­‰å’ŒéŒ¯èª¤è™•ç†
}
```

### 3. ä¾è³´æ³¨å…¥ (Context)

```typescript
// RepoProvider.tsx
const RepoCtx = React.createContext<{
  quotes: QuoteRepo;
} | null>(null);

export const RepoProvider: React.FC<{children: React.ReactNode}> = ({children}) => {
  const quotes = useMemo(() => new LocalQuoteRepo(), []);
  return <RepoCtx.Provider value={{quotes}}>{children}</RepoCtx.Provider>;
};

export const useQuotes = () => {
  const ctx = useContext(RepoCtx);
  if (!ctx) throw new Error("RepoProvider missing");
  return ctx.quotes;
};
```

---

## ğŸ“Š æ•¸æ“šæµç¨‹

### 1. å‰µå»ºå ±åƒ¹æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ¶é»æ“Šæ–°å¢å ±åƒ¹] --> B[QuoteEditor mode=create]
    B --> C[è¼‰å…¥é è¨­å€¼/ç¯„æœ¬]
    C --> D[ç”¨æˆ¶å¡«å¯«åŸºæœ¬è³‡è¨Š]
    D --> E[ç”¨æˆ¶è¨­å®šè¨ˆç®—åƒæ•¸]
    E --> F[AppOptimized è¨ˆç®—]
    F --> G[ç”¨æˆ¶é»æ“Šå„²å­˜]
    G --> H[quotes.create]
    H --> I[ç”Ÿæˆ ID/Code]
    I --> J[è¨ˆç®— derived æ•¸æ“š]
    J --> K[ä¿å­˜åˆ° localStorage]
    K --> L[è·³è½‰åˆ°å ±åƒ¹æª¢è¦–]
```

### 2. ç·¨è¼¯å ±åƒ¹æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ¶é»æ“Šç·¨è¼¯å ±åƒ¹] --> B[QuoteEditor mode=edit]
    B --> C[quotes.get è¼‰å…¥ç¾æœ‰æ•¸æ“š]
    C --> D[å‰µå»º working copy]
    D --> E[ç”¨æˆ¶ä¿®æ”¹æ•¸æ“š]
    E --> F[æª¢æ¸¬ dirty state]
    F --> G[ç”¨æˆ¶é»æ“Šå„²å­˜]
    G --> H[quotes.update]
    H --> I[é‡æ–°è¨ˆç®— derived]
    I --> J[æ›´æ–° localStorage]
    J --> K[æ›´æ–° UI ç‹€æ…‹]
```

### 3. æ•¸æ“šåŒæ­¥æµç¨‹

```mermaid
graph TD
    A[AppOptimized è¨ˆç®—] --> B[ä¿å­˜åˆ° localStorage]
    B --> C[QuoteEditor è®€å–]
    C --> D[åˆä½µåˆ° form.inputs]
    D --> E[ç”¨æˆ¶å„²å­˜]
    E --> F[quotes.create/update]
    F --> G[ç”Ÿæˆ derived å¿«ç…§]
    G --> H[æ›´æ–° Dashboard/List]
```

---

## ğŸ”Œ API æ¥å£è¨­è¨ˆ (æœªä¾†æ“´å±•)

### 1. RESTful API è¨­è¨ˆ

```typescript
// å ±åƒ¹å–®ç®¡ç†
GET    /api/quotes              // ç²å–å ±åƒ¹å–®åˆ—è¡¨
POST   /api/quotes              // å‰µå»ºæ–°å ±åƒ¹å–®
GET    /api/quotes/:id          // ç²å–ç‰¹å®šå ±åƒ¹å–®
PUT    /api/quotes/:id          // æ›´æ–°å ±åƒ¹å–®
DELETE /api/quotes/:id          // åˆªé™¤å ±åƒ¹å–®
POST   /api/quotes/:id/duplicate // è¤‡è£½å ±åƒ¹å–®

// çµ±è¨ˆåˆ†æ
GET    /api/dashboard/stats     // ç²å–å„€è¡¨æ¿çµ±è¨ˆ
GET    /api/dashboard/trends    // ç²å–è¶¨å‹¢æ•¸æ“š
GET    /api/dashboard/cost-share // ç²å–æˆæœ¬å æ¯”

// æ•¸æ“šç®¡ç†
POST   /api/import              // å°å…¥æ•¸æ“š
GET    /api/export              // å°å‡ºæ•¸æ“š
```

### 2. æ•¸æ“šå‚³è¼¸æ ¼å¼

```typescript
// è«‹æ±‚æ ¼å¼
interface CreateQuoteRequest {
  meta: QuoteMeta;
  inputs: QuoteInputs;
}

// éŸ¿æ‡‰æ ¼å¼
interface QuoteResponse {
  success: boolean;
  data?: Quote;
  error?: string;
  message?: string;
}

// åˆ—è¡¨éŸ¿æ‡‰
interface QuoteListResponse {
  success: boolean;
  data: {
    quotes: Quote[];
    total: number;
    page: number;
    limit: number;
  };
}
```

---

## ğŸ¯ é—œéµè¨­è¨ˆåŸå‰‡

### 1. å–®ä¸€äº‹å¯¦ä¾†æº
- **è¨ˆç®—åƒæ•¸**: `quote.inputs` æ˜¯å”¯ä¸€ä¾†æº
- **é¡¯ç¤ºæ•¸æ“š**: å„ªå…ˆä½¿ç”¨ `quote.derived` å¿«ç…§
- **å…ƒæ•¸æ“š**: `quote.meta` ä¸åƒèˆ‡è¨ˆç®—

### 2. æ•¸æ“šåˆ†å±¤
- **Meta**: å®¢æˆ¶/å–®æ“šä¿¡æ¯ (ä¸å½±éŸ¿è¨ˆç®—)
- **Inputs**: è¨ˆç®—åƒæ•¸ (å”¯ä¸€ä¾†æº)
- **Derived**: è¨ˆç®—çµæœ (å¿«ç…§)

### 3. ç‰ˆæœ¬æ§åˆ¶
- æ”¯æŒæ•¸æ“šçµæ§‹å‡ç´š
- å‘å¾Œå…¼å®¹æ€§
- é·ç§»ç­–ç•¥

### 4. éŒ¯èª¤è™•ç†
- æ•¸æ“šé©—è­‰
- é¡å‹å®‰å…¨
- å„ªé›…é™ç´š

---

## ğŸ“ ä½¿ç”¨ç¯„ä¾‹

### 1. å‰µå»ºæ–°å ±åƒ¹

```typescript
const newQuote = await quotes.create({
  meta: {
    customerName: "ABC è²¿æ˜“å…¬å¸",
    contactInfo: "contact@abc.com",
    paymentTerms: "T/T 30 days"
  },
  inputs: {
    incotermFrom: "EXW",
    incotermTo: "CIF",
    markupMode: "margin",
    markupPct: 15,
    currency: "USD",
    products: [...],
    costs: {...},
    logistics: {...}
  }
});
```

### 2. æ›´æ–°å ±åƒ¹

```typescript
const updatedQuote = await quotes.update(quoteId, {
  meta: {
    customerName: "æ›´æ–°å¾Œçš„å®¢æˆ¶åç¨±"
  },
  inputs: {
    markupPct: 20  // ä¿®æ”¹åŠ åƒ¹ç‡
  }
});
```

### 3. ç²å–çµ±è¨ˆæ•¸æ“š

```typescript
const stats = await quotes.getStats();
// è¿”å›: { totalQuotes, avgMargin, totalValue, openQuotes }

const trends = await quotes.getTrendData();
// è¿”å›: [{ date, count, totalQuote }]

const costShare = await quotes.getCostShareData();
// è¿”å›: [{ label, value, percentage }]
```

---

*æ­¤æ–‡æª”è¨˜éŒ„äº† Incoterm å ±åƒ¹ç³»çµ±çš„å®Œæ•´æ•¸æ“šçµæ§‹å’Œå­˜å„²æ¶æ§‹ï¼Œç‚ºæœªä¾†çš„é–‹ç™¼å’Œç¶­è­·æä¾›åƒè€ƒã€‚*
