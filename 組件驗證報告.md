# Incoterm è¨ˆç®—å™¨çµ„ä»¶é©—è­‰å ±å‘Š

## ğŸ“Š **çµ„ä»¶æ¶æ§‹ç¸½è¦½**

### **æ•¸æ“šæµå‘ï¼š**
```
inputs (ç”¨æˆ¶è¼¸å…¥) â†’ calculateAllProductQuotes() â†’ productQuotes â†’ UI çµ„ä»¶
```

### **æ ¸å¿ƒè¨ˆç®—å‡½æ•¸ï¼š**
- `calculateAllProductQuotes(inputs)` - è¨ˆç®—æ‰€æœ‰å•†å“å ±åƒ¹
- `calculateCostBreakdown(inputs)` - è¨ˆç®—æˆæœ¬æ˜ç´°
- `calculateProductQuote(product, inputs)` - è¨ˆç®—å€‹åˆ¥å•†å“å ±åƒ¹

---

## ğŸ¯ **1. è¨ˆç®—çµæœçµ„ä»¶ (è¨ˆç®—çµæœ)**

### **æ•¸æ“šä¾†æºï¼š**
- **å–®ä½å ±åƒ¹**ï¼š`productQuotes.products[0]?.suggestedQuote`
- **å–®ä½æˆæœ¬**ï¼š`productQuotes.products[0]?.unitCost`
- **ç¸½å ±åƒ¹**ï¼š`productQuotes.products.reduce((sum, p) => sum + p.totalProductValue, 0)`
- **æ¯›åˆ©ç‡**ï¼š`profitMargin` (å‹•æ…‹è¨ˆç®—)

### **æ¯›åˆ©ç‡è¨ˆç®—é‚è¼¯ï¼š**
```typescript
const profitMargin = useMemo(() => {
  const product = productQuotes.products[0];
  if (product?.suggestedQuote && product?.unitCost && product.suggestedQuote > 0) {
    const margin = (product.suggestedQuote - product.unitCost) / product.suggestedQuote;
    return margin; // è¿”å›å°æ•¸å€¼ï¼Œå¦‚ 0.1198
  }
  return 0;
}, [productQuotes.products]);
```

### **é¡¯ç¤ºæ ¼å¼åŒ–ï¼š**
```typescript
// labelPct å‡½æ•¸æœƒå°‡å°æ•¸å€¼ä¹˜ä»¥ 100 ä¸¦åŠ ä¸Š % ç¬¦è™Ÿ
const labelPct = useCallback((val: number) => 
  `${(val * 100).toFixed(2)}%`, []
);
```

### **é©—è­‰çµæœï¼š**
- âœ… **æ•¸æ“šä¾†æºçµ±ä¸€** - å…¨éƒ¨ä½¿ç”¨ `productQuotes` æ•¸æ“š
- âœ… **è¨ˆç®—é‚è¼¯æ­£ç¢º** - æ¯›åˆ©ç‡ = (å”®åƒ¹ - æˆæœ¬) / å”®åƒ¹
- âœ… **æ ¼å¼åŒ–æ­£ç¢º** - é¿å…é›™é‡ä¹˜ä»¥ 100 çš„å•é¡Œ

---

## ğŸ“‹ **2. æˆæœ¬æ˜ç´°è¡¨çµ„ä»¶ (æˆæœ¬æ˜ç´°)**

### **æ•¸æ“šä¾†æºï¼š**
- **ä¾›æ‡‰å•†è²¨å€¼**ï¼š`derived.sumVal`
- **å„é …è²»ç”¨**ï¼š`productQuotes.costBreakdown.*`

### **é©ç”¨æ€§åˆ¤æ–·é‚è¼¯ï¼š**
```typescript
// èˆŠé‚è¼¯ (å·²ç§»é™¤)
{calc.need_EXW_to_FOB && (è²»ç”¨é …ç›®)}

// æ–°é‚è¼¯ (ç¾ç”¨)
{productQuotes.costBreakdown.logisticsCosts.inlandToPort > 0 && (è²»ç”¨é …ç›®)}
```

### **è²»ç”¨é …ç›®å°æ‡‰ï¼š**
| è²»ç”¨é …ç›® | æ•¸æ“šä¾†æº | é©ç”¨æ€§åˆ¤æ–· |
|---------|----------|------------|
| å·¥å» åˆ°æ¸¯å£ | `logisticsCosts.inlandToPort` | `> 0` |
| å‡ºå£æ–‡ä»¶ | `fixedCosts.exportDocsClearance` | `> 0` |
| æ¸¯å£é›œè²» | `fixedCosts.originPortFees` | `> 0` |
| æµ·é‹/ç©ºé‹ | `logisticsCosts.mainFreight` | `> 0` |
| è²¨ç‰©ä¿éšª | `logisticsCosts.insurance` | `> 0` |
| ç›®çš„æ¸¯é›œè²» | `fixedCosts.destPortFees` | `> 0` |
| é€²å£ä»£ç† | `fixedCosts.importBroker` | `> 0` |
| æœ«ç«¯é…é€ | `fixedCosts.lastMileDelivery` | `> 0` |
| é›œé …è²»ç”¨ | `fixedCosts.misc` | ç¸½æ˜¯é¡¯ç¤º |

### **é©—è­‰çµæœï¼š**
- âœ… **é©ç”¨æ€§åˆ¤æ–·çµ±ä¸€** - ä½¿ç”¨æ–°é‚è¼¯çš„å¯¦éš›è²»ç”¨å€¼
- âœ… **æ•¸æ“šä¾†æºä¸€è‡´** - å…¨éƒ¨ä½¿ç”¨ `productQuotes.costBreakdown`
- âœ… **è²¿æ˜“æ¢ä»¶æ­£ç¢º** - FOBâ†’FOB ä¸æœƒé¡¯ç¤ºä¸é©ç”¨çš„è²»ç”¨

---

## ğŸ·ï¸ **3. å•†å“å€‹åˆ¥å ±åƒ¹çµ„ä»¶ (å•†å“1)**

### **æ•¸æ“šä¾†æºï¼š**
- **æ•¸é‡**ï¼š`product.qty`
- **ä¾›æ‡‰å•†å–®åƒ¹**ï¼š`product.supplierUnitPrice`
- **å–®ä½æˆæœ¬**ï¼š`product.unitCost`
- **å»ºè­°å ±åƒ¹**ï¼š`product.suggestedQuote`
- **å–®ä½åˆ©æ½¤**ï¼š`product.unitProfit`
- **å•†å“ç¸½åƒ¹**ï¼š`product.totalProductValue`

### **è¨ˆç®—é‚è¼¯ï¼š**
```typescript
// å–®ä½æˆæœ¬ = ä¾›æ‡‰å•†å–®åƒ¹ + åˆ†æ”¤æˆæœ¬
const unitCost = supplierUnitPrice + productAllocation.perUnitAllocatedCosts;

// å»ºè­°å ±åƒ¹ = å–®ä½æˆæœ¬ Ã— (1 + åŠ åƒ¹ç‡%) æˆ– å–®ä½æˆæœ¬ Ã· (1 - æ¯›åˆ©ç‡%)
let suggestedQuote = unitCost;
if (inputs.pricingMode === 'markup') {
  suggestedQuote = unitCost * (1 + (inputs.markupPct || 0) / 100);
} else if (inputs.pricingMode === 'margin') {
  const margin = (inputs.marginPct || 0) / 100;
  suggestedQuote = unitCost / (1 - margin);
}

// å–®ä½åˆ©æ½¤ = å»ºè­°å ±åƒ¹ - å–®ä½æˆæœ¬
const unitProfit = suggestedQuote - unitCost;

// å•†å“ç¸½åƒ¹ = å»ºè­°å ±åƒ¹ Ã— æ•¸é‡
const totalProductValue = suggestedQuote * productQty;
```

### **é©—è­‰çµæœï¼š**
- âœ… **æ•¸æ“šä¾†æºçµ±ä¸€** - å…¨éƒ¨ä½¿ç”¨ `productQuotes.products[0]`
- âœ… **è¨ˆç®—é‚è¼¯æ­£ç¢º** - ç¬¦åˆæ‚¨çµ¦çš„å®šåƒ¹å…¬å¼
- âœ… **åˆ©æ½¤è¨ˆç®—æ­£ç¢º** - å–®ä½åˆ©æ½¤ = å»ºè­°å ±åƒ¹ - å–®ä½æˆæœ¬

---

## ğŸ“Š **4. ç¸½è¨ˆçµ„ä»¶ (ç¸½è¨ˆ)**

### **æ•¸æ“šä¾†æºï¼š**
- **ç¸½æ•¸é‡**ï¼š`productQuotes.products.reduce((sum, p) => sum + p.qty, 0)`
- **ç¸½åˆ©æ½¤**ï¼š`productQuotes.products.reduce((sum, p) => sum + p.unitProfit * p.qty, 0)`
- **ç¸½å ±åƒ¹**ï¼š`productQuotes.products.reduce((sum, p) => sum + p.totalProductValue, 0)`

### **é©—è­‰çµæœï¼š**
- âœ… **æ•¸æ“šä¾†æºçµ±ä¸€** - å…¨éƒ¨ä½¿ç”¨ `productQuotes.products` çš„åŒ¯ç¸½
- âœ… **è¨ˆç®—é‚è¼¯æ­£ç¢º** - æ•¸é‡ã€åˆ©æ½¤ã€å ±åƒ¹çš„ç¸½å’Œè¨ˆç®—

---

## ğŸ”§ **5. æ ¸å¿ƒè¨ˆç®—å‡½æ•¸é©—è­‰**

### **calculateCostBreakdown å‡½æ•¸ï¼š**
```typescript
export function calculateCostBreakdown(inputs: Inputs) {
  // ä½¿ç”¨çµ±ä¸€çš„ calculateQuote å‡½æ•¸
  const quoteResult = calculateQuote({...});
  
  // æ ¹æ“šè²¿æ˜“æ¢ä»¶éæ¿¾è²»ç”¨
  const add = {
    inlandToPort: inputs.supplierTerm === "EXW" && idx(inputs.targetTerm) >= idx("FOB"),
    exportDocs: idx(inputs.targetTerm) >= idx("FOB"),
    mainFreight: idx(inputs.targetTerm) >= idx("CFR") && idx(inputs.supplierTerm) < idx("CFR"),
    insurance: idx(inputs.targetTerm) >= idx("CIF") && idx(inputs.supplierTerm) < idx("CIF"),
    // ... å…¶ä»–è²»ç”¨
  };
  
  // åˆ†é¡æˆæœ¬
  const fixedCosts = {...};
  const logisticsCosts = {...};
  
  return {
    fixedCosts,
    logisticsCosts,
    totalCosts: totalFixedCosts + totalLogisticsCosts,
    costAllocation
  };
}
```

### **calculateProductQuote å‡½æ•¸ï¼š**
```typescript
export function calculateProductQuote(product: Product, inputs: Inputs) {
  const costBreakdown = calculateCostBreakdown(inputs);
  const productAllocation = costBreakdown.costAllocation.find(...);
  
  // å–®ä½æˆæœ¬ = ä¾›æ‡‰å•†å–®åƒ¹ + åˆ†æ”¤æˆæœ¬
  const unitCost = supplierUnitPrice + productAllocation.perUnitAllocatedCosts;
  
  // å»ºè­°å ±åƒ¹è¨ˆç®—
  let suggestedQuote = unitCost;
  if (inputs.pricingMode === 'markup') {
    suggestedQuote = unitCost * (1 + (inputs.markupPct || 0) / 100);
  } else if (inputs.pricingMode === 'margin') {
    const margin = (inputs.marginPct || 0) / 100;
    suggestedQuote = unitCost / (1 - margin);
  }
  
  return {
    unitCost,
    suggestedQuote,
    unitProfit: suggestedQuote - unitCost,
    totalProductValue: suggestedQuote * productQty
  };
}
```

---

## âœ… **ç¸½çµé©—è­‰çµæœ**

### **æ•¸æ“šä¸€è‡´æ€§ï¼š**
- âœ… **æ‰€æœ‰çµ„ä»¶éƒ½ä½¿ç”¨çµ±ä¸€çš„æ•¸æ“šæº** - `productQuotes`
- âœ… **æ²’æœ‰æ··åˆä½¿ç”¨èˆŠé‚è¼¯å’Œæ–°é‚è¼¯**
- âœ… **æˆæœ¬è¨ˆç®—å’Œå ±åƒ¹è¨ˆç®—ä½¿ç”¨ç›¸åŒçš„åŸºç¤æ•¸æ“š**

### **è¨ˆç®—é‚è¼¯æ­£ç¢ºæ€§ï¼š**
- âœ… **æ¯›åˆ©ç‡è¨ˆç®—** - (å”®åƒ¹ - æˆæœ¬) / å”®åƒ¹
- âœ… **å®šåƒ¹å…¬å¼** - ç¬¦åˆæ‚¨çµ¦çš„åŠ åƒ¹ç‡å’Œæ¯›åˆ©ç‡å…¬å¼
- âœ… **æˆæœ¬åˆ†æ”¤** - æ ¹æ“šé¸æ“‡çš„åˆ†æ”¤æ–¹å¼æ­£ç¢ºè¨ˆç®—
- âœ… **é©ç”¨æ€§åˆ¤æ–·** - æ ¹æ“šè²¿æ˜“æ¢ä»¶æ­£ç¢ºéæ¿¾è²»ç”¨

### **é¡¯ç¤ºé‚è¼¯æ­£ç¢ºæ€§ï¼š**
- âœ… **é¿å…é›™é‡ç™¾åˆ†æ¯”è½‰æ›** - æ¯›åˆ©ç‡è¨ˆç®—ä¸ä¹˜ä»¥ 100ï¼Œç”± `labelPct` è™•ç†
- âœ… **è²»ç”¨é …ç›®é¡¯ç¤º** - åªé¡¯ç¤ºå¯¦éš›æœ‰è²»ç”¨çš„é …ç›®
- âœ… **è²¿æ˜“æ¢ä»¶é©ç”¨æ€§** - FOBâ†’FOB ä¸æœƒé¡¯ç¤º EXWâ†’FOB çš„è²»ç”¨

### **æœ€çµ‚çµæœï¼š**
- **æ¯›åˆ©ç‡æ‡‰è©²é¡¯ç¤º**ï¼š11.98% (è€Œä¸æ˜¯ 1198.32%)
- **æ‰€æœ‰æ•¸å€¼æ‡‰è©²ä¸€è‡´**ï¼šä¸ŠåŠéƒ¨å’Œä¸‹åŠéƒ¨çš„æ•¸æ“šå®Œå…¨åŒ¹é…
- **è²»ç”¨é©ç”¨æ€§æ­£ç¢º**ï¼šåªé¡¯ç¤ºçœŸæ­£é©ç”¨çš„è²»ç”¨é …ç›®

---

## ğŸ“ **å»ºè­°æ¸¬è©¦æ¡ˆä¾‹**

1. **è²¿æ˜“æ¢ä»¶ï¼šFOB â†’ FOB**
   - æ‡‰è©²åªé¡¯ç¤ºï¼šä¾›æ‡‰å•†è²¨å€¼ã€å‡ºå£æ–‡ä»¶
   - ä¸æ‡‰è©²é¡¯ç¤ºï¼šå·¥å» åˆ°æ¸¯å£ã€æ¸¯å£é›œè²»ã€æµ·é‹/ç©ºé‹ã€è²¨ç‰©ä¿éšªç­‰

2. **è²¿æ˜“æ¢ä»¶ï¼šEXW â†’ CIF**
   - æ‡‰è©²é¡¯ç¤ºï¼šä¾›æ‡‰å•†è²¨å€¼ã€å·¥å» åˆ°æ¸¯å£ã€å‡ºå£æ–‡ä»¶ã€æ¸¯å£é›œè²»ã€æµ·é‹/ç©ºé‹ã€è²¨ç‰©ä¿éšª

3. **æ¯›åˆ©ç‡é©—è­‰**
   - æˆæœ¬ï¼šJPY 302.78
   - å ±åƒ¹ï¼šJPY 344.00
   - æ¯›åˆ©ç‡ï¼šæ‡‰è©²é¡¯ç¤º 11.98%

---

*å ±å‘Šç”Ÿæˆæ™‚é–“ï¼š2024å¹´12æœˆ*
*é©—è­‰ç‹€æ…‹ï¼šæ‰€æœ‰çµ„ä»¶é‚è¼¯å·²çµ±ä¸€ï¼Œæ•¸æ“šä¾†æºä¸€è‡´*
